<!DOCTYPE html>
<html>
  <head>
  <link rel="shortcut icon" href="../../../public/1616.ico">
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>PHP任意文件上传CVE-2015-2348 漏洞分析 - Posted By Tr3jer</title>
    <meta name="description" content="Hacking for fun. - Tr3jer_CongRong"/>
    <link rel="stylesheet" href="/css/Tr3jer.css" type="text/css" />
    <link rel="stylesheet" href="/css/syntax.css" type="text/css" />
  </head>
  <body>
    <div class="site">
      <div class="post-content">
        <div id="post">
          <h1 id="php任意文件上传cve-2015-2348-漏洞分析">PHP任意文件上传CVE-2015-2348 漏洞分析</h1>
<p class="date">03 Apr 2015 - Tr3jer_CongRong</p>

<p><strong>当时发现这个<a target="_blank" href="https://web.nvd.nist.gov/view/vuln/detail?vulnId=CVE-2015-2348">Vulnerability Summary for CVE-2015-2348</a>漏洞公告的时候,果然是字符截断导致的,存在于PHP高版本中,多数安全研究者都在说漏洞怎么怎么鸡肋的,经过测试表明,还是要看利用的场景而异说明是不是真的很<code>鸡肋</code>.</strong></p>

<h4 id="漏洞分析">漏洞分析:</h4>
<p><code>move_uploaded_file()</code>函数,这个函数是将上传的文件移动到新位置.</p>

<pre><code>move_uploaded_file ( string $filename , string $destination )
</code></pre>

<p>源代码:ext/standard/basic_functions.c</p>

<p><img src="http://blog-1252048719.cos.ap-shanghai.myqcloud.com/43t45ge.png" /></p>

<blockquote>
  <p>这个函数拿php-5.3.x &amp; php5.6.x作比较,发现高版本此函数的长度比较判断被干掉了……</p>
</blockquote>

<pre><code>if (strlen(path) != path_len) {
	RETURN_FALSE;
}

if (strlen(new_path) != new_path_len) {
	RETURN_FALSE;
}
</code></pre>

<p><strong><code>strlen(new_path)</code>为move_uploade_file()-<code>$destination</code>参数的长度(\0截断的话只计算截断前面的字符长度),在PHP中,所有的变量都是用一个结构<code>_zval</code>来保存的,而<code>new_path_len</code>对应着结构体中的<code>int len</code>,由于是二进制保存的,所以计算长度的时候空字符以及后面的字符都会包含在内.</strong></p>

<p><img src="http://blog-1252048719.cos.ap-shanghai.myqcloud.com/3wyesd78iyu.png" /></p>

<blockquote>
  <p>那么当空字符截断的时候,由于长度不等,<code>strlen(new_path) != new_path_len</code>即为FALSE,低版本的截断上传则无效.</p>
</blockquote>

<h4 id="漏洞证明">漏洞证明:</h4>
<blockquote>
  <p>Windows7 &amp; PHP5.4.x</p>
</blockquote>

<p><strong>upload.php</strong></p>

<pre><code>&lt;!doctype html&gt;
&lt;html lang="en"&gt;
&lt;head&gt;
	&lt;meta charset="UTF-8"&gt;
	&lt;title&gt;upload&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
	&lt;form action="" method="post" enctype="multipart/form-data"&gt;
		 &lt;input type="file" name="file"&gt;
		 &lt;input type="submit"&gt;
	&lt;/form&gt;
&lt;/body&gt;
&lt;?php 
echo "&lt;pre&gt;";
var_dump($_FILES);
echo "&lt;/pre&gt;";
	move_uploaded_file($_FILES['file']['tmp_name'], "tmp/eval.php\x00.jpg");
?&gt;
&lt;/html&gt;
</code></pre>

<p><img src="http://blog-1252048719.cos.ap-shanghai.myqcloud.com/3wref.png" /></p>

<blockquote>
  <p>可以看出上传一个.jpg格式的木马在经过move_uploaded_file()转存的时候,截断生效了,截断上传一直都是个简单粗暴的漏洞,但是<code>无脑黑们</code>对这个漏洞不怎么感冒,认为谁会将转存的地址通过$_POST之类的接收呢?</p>
</blockquote>

<p><img src="http://blog-1252048719.cos.ap-shanghai.myqcloud.com/2qwasf.png" /></p>

<h4 id="鸡肋吗">鸡肋吗?</h4>

<p><strong>个人觉得这个漏洞并不是一文不值的,换个角度,以程序员的角度思考下,什么情况下<code>$destination</code>参数需要外部接收呢?</strong></p>

<p><strong>demo.php</strong></p>

<pre><code>&lt;html&gt;
&lt;meta content="text/html" charset="utf-8"&gt;
&lt;body&gt;

&lt;form action="" method="post" enctype="multipart/form-data"&gt;
&lt;label&gt;选择图片:&lt;label&gt;
&lt;input type="file" name="file" /&gt;
&lt;input type="hidden" name="address" value="&lt;?php echo time(); ?&gt;"&gt;
&lt;br /&gt;
&lt;input type="submit" value="Submit" /&gt;
&lt;br /&gt;
&lt;/form&gt;

&lt;/body&gt;
&lt;?php
error_reporting(0);

$upload_name=$_FILES['file']['name'];
$type=substr($upload_name,strrpos($upload_name,'.')+1);

if($type == "jpg" || $type == "png" || $type == "gif"){

	$address=$_POST['address'].".".$type;

	if (move_uploaded_file($_FILES['file']['tmp_name'],"tmp/".$address)) {
		echo "图片地址:tmp/".$address;
	}
	
}else{
echo "上传类型错误!";
}

?&gt;
&lt;/html&gt;
</code></pre>

<p><strong>抓包截断,将time()生成的数字后面加上<code>.php</code>和一个<code>空字符</code>:</strong></p>

<p><img src="http://blog-1252048719.cos.ap-shanghai.myqcloud.com/3regrfd.PNG" /></p>

<p><strong>截断上传成功后从文件名上也会发现漏洞存在于此函数:</strong></p>

<p><img src="http://blog-1252048719.cos.ap-shanghai.myqcloud.com/w23sdf.PNG" /></p>

<p><strong>只是个简单的测试demo,因场景而异漏洞还是会存在的,毕竟\0是C的特性,当演变成了漏洞后,就要看开发者是否认真对待.</strong></p>

<ul>
  <li><code>$destination</code>不要使用$_GET或者$_POST来接收</li>
  <li>$_FILES[‘file’][‘name’]不受影响,推荐作为<code>$destination</code>参数</li>
  <li>漏洞涉及的版本存在于PHP5.4.38-5.6.6</li>
</ul>

        </div>
      </div>
      
      <div id="disqus_thread"></div>
      <script type="text/javascript">
      /* * * CONFIGURATION VARIABLES * * */
      var disqus_shortname = 'tr3jer';
      
      /* * * DON'T EDIT BELOW THIS LINE * * */
      (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
      </script>
      <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
      <div id="disqus_thread"></div>

      <!-- footer -->
      <div class="footer">
        <div class="contact">
          <p>
            <a href="/" style="text-decoration: none; margin-right: 5px;">Index</a> |&nbsp;
            <a href="/feed.xml" target="_blank" style="text-decoration: none; margin-right: 5px;">RSS</a> |&nbsp;
            <a href="http://github.com/tr3jer" target="_blank" style="text-decoration: none; margin-right: 5px;">Github</a> |&nbsp;
            <a href="http://weibo.com/Tr3jer" target="_blank" style="text-decoration: none; margin-right: 5px;">Weibo</a> |&nbsp;
            <a href="https://twitter.com/Tr3jer" target="_blank" style="text-decoration: none; margin-right: 5px;">Twitter</a> |&nbsp;
            <a href="/link" target="_blank" style="text-decoration: none; margin-right: 5px;">Links</a> |&nbsp;
            <a href="/mail.txt" target="_blank">Gmail</a>
          </p>
        </div>
      </div>
    </div>

    <div style="display: none;">
      <script src="https://s23.cnzz.com/z_stat.php?id=1275554055&web_id=1275554055" language="JavaScript"></script>
    </div>
  </body>
</html>
